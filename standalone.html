<body><canvas id='target' width=512 height=256></canvas></body>
<style>body{margin:0px;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;}</style>
<script>
const emulator = new Emulator()
unpackOptions(emulator, data.options)
setRenderTarget(data.options.displayScale || 4, 'target')
emulator.init({rom:data.rom})
emulator.importFlags = _ => getPref('octoFlagRegisters')
emulator.exportFlags = f => setPref('octoFlagRegisters',f)
//audio setup
var XOAudioA = new audioEngine(); XOAudioA.setGain(1);
var XOAudioB = new audioEngine(); XOAudioB.setGain(1);
emulator.buzzTimer[0] = timer => XOAudioA.setTimer(timer)
emulator.buzzTimer[1] = timer => XOAudioB.setTimer(timer)
emulator.buzzPitch[0] = pitch => XOAudioA.setPitch(pitch)
emulator.buzzPitch[1] = pitch => XOAudioB.setPitch(pitch)
emulator.buzzVolume[0] = volume => XOAudioA.setVolume(volume)
emulator.buzzVolume[1] = volume => XOAudioB.setVolume(volume)
emulator.buzzPitchRamp[0] = ramp => XOAudioA.setPitchRamp(ramp)
emulator.buzzPitchRamp[1] = ramp => XOAudioB.setPitchRamp(ramp)
emulator.buzzVolumeRamp[0] = ramp => XOAudioA.setVolumeRamp(ramp)
emulator.buzzVolumeRamp[1] = ramp => XOAudioB.setVolumeRamp(ramp)
emulator.buzzBuffer[0] = (buffer,mode) => XOAudioA.setBuffer(buffer,mode)
emulator.buzzBuffer[1] = (buffer,mode) => XOAudioB.setBuffer(buffer,mode)


const kd = e=>{
	if (!audio) audioEnable()
	if (!(e.key in emulator.keys)) emulator.keys[e.key]=true
	e.preventDefault()
}
const ku = e=>{
	if (e.key in emulator.keys) delete emulator.keys[e.key]
	if (!emulator.waiting) return
	const kindex = keymapInverse[e.key]
	if (kindex != undefined) {
		emulator.waiting = false
		emulator.v[emulator.waitReg] = kindex
	}
	e.preventDefault()
}
window.addEventListener('keydown',kd,false)
window.addEventListener('keyup',ku,false)
intervalHandle = setInterval(_=>{
	if (emulator.halted) return
	for(var z = 0; (z<emulator.tickrate) && (!emulator.waiting); z++) emulator.tick()
	if (emulator.st[0]> 0) emulator.st[0]--
	if (emulator.st[1]> 0) emulator.st[1]--
	if (emulator.dt > 0) emulator.dt--
	renderDisplay(emulator)
	XOAudioA.refresh(); XOAudioB.refresh();
	document.body.style.backgroundColor = emulator.st?emulator.buzzColor:emulator.quietColor
}, 1000/60)

injectAdaptiveControls(emulator.touchInputMode,document.getElementById('target'),ku,kd)
</script>
